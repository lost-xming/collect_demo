<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>输入提示后查询</title>
		<script type="text/javascript" src="http://s4.dxlfile.com/??public/js/jquery-2.1.0.min.js,public/js/dxl2.js,public/js/m.js"></script>
		<!-- <script language="javascript" src="http://webapi.amap.com/maps?v=1.3&key=a76729d8990e2aac7c24d3bd99db069b"></script> -->
		<script language="javascript" src="http://webapi.amap.com/maps?v=1.2&key=a36c26f01981131ca4f870ac5f867cc9"></script>
		<style>
			* {margin: 0; padding: 0;}
		</style>
		<script type="text/javascript">
			$(function(){
				$.mAppInit({
					"appleApp"   : function(){
						doSearch = function(data){
							Citylist = data;
						};
						doClick = function(txt){
							currAddressTxt = txt;
						};
					},
					"iPadApp"    : function(){
						doSearch = function(data){
							Citylist = data;
						};
						doClick = function(txt){
							currAddressTxt = txt;
						};
					},
					"androidApp" : function(){
						doSearch = function(data){
							window.client && window.client.backJsonForAndroid && window.client.backJsonForAndroid(JSON.stringify(data));
						};
						doClick = function(txt){
							window.client && window.client.backAddressForAndroid && window.client.backAddressForAndroid(txt);
						};
						doComplete = function(){
							window.client && window.client.doComplete && window.client.doComplete();
						};
					},
					"otherBrowser" : function(){
						doSearch = function(data){
							window.client && window.client.backJsonForAndroid && window.client.backJsonForAndroid(JSON.stringify(data));
						};
						doClick = function(txt){
							window.client && window.client.backAddressForAndroid && window.client.backAddressForAndroid(txt);
						};
						doComplete = function(){
							window.client && window.client.doComplete && window.client.doComplete();
						}
					}
				});
			});
			//
			var ditu, CitySearch, PlaceSearch, Geolocation,isFinished,
				markerList = [], windowList = [], currCityName = "全国", currAddressTxt = "",
				searchHandler, Citylist, 
				doSearch, doClick, doComplete;
			// 
			function search(keyword, callback){
				if (PlaceSearch && keyword) {
					markerList = [];
					windowList = [];
					callback && (searchHandler = callback);
					var _cityName = currCityName, index = _cityName.indexOf("市");
					if (index != -1) {
						_cityName = _cityName.substring(0, index);
					}
					if (keyword.indexOf(_cityName) == -1) {
						keyword = _cityName + keyword;
					}
					PlaceSearch.search(keyword);
				}
			}
			function setLocation(keyword, xindex){
				if (!keyword) return false;
				var _cityName = currCityName, index = _cityName.indexOf("市");
				if (index != -1) {
					_cityName = _cityName.substring(0, index);
				}
				if (keyword.indexOf(_cityName) == -1) {
					keyword = _cityName + keyword;
				}
				//Geocoder.getLocation(keyword);
				//
				//if (windowList[xindex] && windowList[xindex].open && markerList[xindex] && markerList[xindex].getPosition) {
				//	windowList[xindex].open(ditu, markerList[xindex].getPosition());
				//}
				setLocationByIndex(xindex);
			}
			function setLocationByIndex(xindex){
				if (windowList[xindex] && windowList[xindex].open && markerList[xindex] && markerList[xindex].getPosition) {
					var poi = markerList[xindex].getPosition();
					windowList[xindex].open(ditu, poi);
					setCurrentPosition(poi.getLng(), poi.getLat());
					//info.value = (markerList.length + " <> " + xindex);
					for (var i = 0; i < markerList.length; i++) {
						if (i != xindex) {
							markerList[i].hide();
						}
					}
				}
			}
			/*
			 * @param{lng Number} longitude
			 * @param{lat Number} latitude
			 */
			function setCurrentPosition(lng, lat){
				//ditu.setCenter(new AMap.LngLat(lng, lat));
				ditu.setZoomAndCenter(16, new AMap.LngLat(lng, lat));
			}
			function getAddress(){
				return currAddressTxt || "";
			}
			function init() {
				dituDom = document.getElementById("demo");
				info = document.getElementById("info");
				var w = GetQueryString("w") || $(window).width(), h = GetQueryString("h") || $(window).height();
				if (dituDom && w && h) {
					dituDom.style.width  = w + "px";
					dituDom.style.height = h + "px";
				}
				ditu = new AMap.Map("demo", {
					zooms: [3,18],
					level: 16,
					keyboardEnable: false
				});
				AMap.event.addListener(ditu, "complete", function(){
					isFinished = 1;
					doComplete && doComplete();
				});
				// 加载插件
				ditu.plugin(["AMap.CitySearch", "AMap.PlaceSearch", "AMap.Geolocation", "AMap.Geocoder", "AMap.ToolBar"], function(){
					// 城市信息
					CitySearch = new AMap.CitySearch();
					CitySearch.getLocalCity();
					AMap.event.addListener(CitySearch, "complete", function(result){
						currCityName = result.city;
					});
					// 搜索插件
					PlaceSearch = new AMap.PlaceSearch();
					AMap.event.addListener(PlaceSearch, "complete", searchComplete_Callback);
					// 浏览器定位插件
					Geolocation = new AMap.Geolocation({
						timeout: 10000
					});
					ditu.addControl(Geolocation);
					AMap.event.addListener(Geolocation, "complete", geolocationComplate_Callback);
					Geolocation.getCurrentPosition();
					/*
					if (navigator.geolocation) {
						navigator.geolocation.getCurrentPosition(function success(position) {
							alert("success");
							var longitude = position.coords.longitude;
							var latitude = position.coords.latitude;
							setCurrentPosition(longitude, latitude);
						}, function error(error) {
							switch (error.code) {
								case 0:
									alert(error);
									break;
								case 1:
									alert("用户选择拒绝浏览器获得其位置信息【" + error.message + "】！");
									break;
								case 2:
									alert("尝试获取用户位置数据失败【" + error.message + "】！");
									break;
								case 3:
									alert("获取用户位置超时【" + error.message + "】！");
									break;
								default:
									break;
							}
						}, {
							enableHighAccuracy : false,  //高精度模式
							timeout            : 10000,  //超时设置
							maximumAge         : 0       //
						});
					}
					//
					toolBar = new AMap.ToolBar();
					ditu.addControl(toolBar);
					AMap.event.addListener(toolBar,'location',function callback(e){	
						//locationInfo = e.lnglat;
					});
					*/
					//
					Geocoder = new AMap.Geocoder();
					AMap.event.addListener(Geocoder, "complete", geocoderComplate_Callback);
				});
			}
			// 将搜索结果显示在地图上面
			function searchComplete_Callback(data) {
				markerList = [];
				windowList = [];
				Citylist=data;
				// 根据环境处理搜索结果
				doSearch && doSearch(data);
				if (typeof searchHandler == "function") {
					searchHandler(data);
				}
				ditu.clearMap();
				var addresses = data.poiList.pois, retHtml = "";
				if (addresses.length == 0) {
					return false;
				}
				for (var i = 0; i < addresses.length; i++) {
					addMarker(addresses[i], i);
				}
				ditu.setFitView();
			}
			function backk() {
				return JSON.stringify(Citylist);
			}
			// 为地点添加标记、信息提示弹窗
			function addMarker(address, index) {
				var lng = address.location.getLng();
				var lat = address.location.getLat();
				var markerOption = {
					map      : ditu,
					icon     : "http://webapi.amap.com/images/" + (index + 1) + ".png",
					position : new AMap.LngLat(lng, lat)
				};
				var marker = new AMap.Marker(markerOption);
				//markerList.push(new AMap.LngLat(lng, lat));
				markerList.push(marker);
				var infoWindow = new AMap.InfoWindow({
					content : "<h5 style=\"margin: 5px 0;\"><font color=\"#00a6ac\">&nbsp;" + (index + 1) + ". " + address.name + "</font></h5>" + rowHtml(address),
					size    : new AMap.Size(300, 0),
					autoMove: true,
					offset  : new AMap.Pixel(0, -30)
				});
				AMap.event.addListener(infoWindow, "close", function(){
					for (var i = 0; i < markerList.length; i++) {
						markerList[i].show();
					}
				});
				windowList.push(infoWindow);
				var openInfoWindow = function (e) {
					infoWindow.open(ditu, marker.getPosition());
					infoWindow.hf.onclick = function(evt){
						var txt = this.children[0].children[1].textContent.replace(/电话.*/, "").replace(/地址：/, "");
						// 根据环境处理点击位置的地址
						doClick && doClick(txt);
					};
				};
				AMap.event.addListener(marker, "click", openInfoWindow);
			}
			// 将地址信息转换成Html
			function rowHtml (address, hasEvent) {
				var retHtml = "";
				if (!address) return retHtml;
				retHtml += '<p style="font-size: 12px;">';
				retHtml += "地址：" + (address.address ? address.address : "暂无") + "<br>";
				retHtml += "电话：" + (address.tel ? address.tel : "暂无") + "<br>";
				retHtml += "类型：" + (address.type ? address.type : "暂无");
				retHtml += '</p>';
				return retHtml;
			}
			// 定位插件回调函数
			function geolocationComplate_Callback(data){
				//console.debug(data);
			}
			// 地址编码插件回调函数
			function geocoderComplate_Callback(data) {
				if (!data || data.resultNum < 1) return false;
				var address = data.geocodes[0];
				//ditu.setCenter(new AMap.LngLat(address.location.lng, address.location.lat));
				ditu.setZoomAndCenter(16, new AMap.LngLat(address.location.lng, address.location.lat));
			}
			function GetQueryString(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
				var r = window.location.search.substr(1).match(reg);
				if (r != null) return unescape(r[2]); return null;
			}
			function checkIsFinish(){
				return isFinished;
			}
		</script>
	</head>
	<body onload="init()">
		<div id="demo" style="width: 800px; height: 500px; margin: 0 auto;"></div>
		<!---
		<textarea id="info" style="position: absolute; left: 0px; bottom: 0px; width: 100%; height: 100px; z-index: 1000; opacity: 0.8;"></textarea>
		-->
	</body>
</html>